package com.sparcedge.turbine.blade

import akka.actor.{ActorSystem,Actor,Props}
import com.sparcedge.turbine.blade.config.BladeConfig
import com.sparcedge.turbine.blade.mongo.MongoDBConnection
import com.sparcedge.turbine.blade.util.{Timer,DiskUtil}
import com.sparcedge.turbine.blade.query.Blade

object TurbineBlade extends App {

	val configStr = args.headOption.getOrElse {
		throw new Exception("No Configuration Supplied")
	}

	val config = BladeConfig(configStr)
	val actorSystem = ActorSystem("TurbineBladeActorSystem")
	val mongoConnection = MongoDBConnection(config)
	val printTimings = config.printTimings.getOrElse(false)
	val preloadBlades = config.preloadBlades.getOrElse(List[Blade]())
	val dataDirectory = config.dataDirectory.getOrElse("data")

	val bladeManager = actorSystem.actorOf(Props(new TurbineBladeManager(mongoConnection, preloadBlades)), name = "BladeManager")

	Timer.printTimings = printTimings
	DiskUtil.BASE_PATH = dataDirectory

	println("{\"status\": \"running\"}")

	for( rawQuery <- io.Source.fromInputStream(System.in)("UTF-8").getLines ) {
		var newQuery = rawQuery
		if(newQuery == "run1") {
			newQuery = "{\"qid\":\"1234\",\"blade\":{\"domain\":\"4f6a2eec61faa7fe1d000035\",\"tenant\":\"4f6a314d61faa7fe1d000051\",\"category\":\"clamp-data\",\"period\":\"2012-08\"},\"query\":{\"range\":{\"start\":1344052800000,\"end\":1346731200000},\"category\":\"clamp-data\",\"match\":{\"resource\":{\"eq\":\"810vermont\"}},\"group\":[{\"type\":\"resource\"}],\"reduce\":{\"reducers\":[{\"propertyName\":\"grp-floor-11-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-11-airhandlers-kW\"},{\"propertyName\":\"grp-floor-11-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-11-plugs-kW\"},{\"propertyName\":\"grp-floor-11-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-11-lghts-kW\"},{\"propertyName\":\"grp-floor-11-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-11-kW\"},{\"propertyName\":\"grp-section-11a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-11a-kW\"},{\"propertyName\":\"grp-section-11c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-11c-kW\"},{\"propertyName\":\"grp-section-11d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-11d-kW\"},{\"propertyName\":\"grp-floor-10-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-10-airhandlers-kW\"},{\"propertyName\":\"grp-floor-10-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-10-plugs-kW\"},{\"propertyName\":\"grp-floor-10-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-10-lghts-kW\"},{\"propertyName\":\"grp-floor-10-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-10-kW\"},{\"propertyName\":\"grp-section-10a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-10a-kW\"},{\"propertyName\":\"grp-section-10c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-10c-kW\"},{\"propertyName\":\"grp-section-10d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-10d-kW\"},{\"propertyName\":\"grp-floor-9-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-9-airhandlers-kW\"},{\"propertyName\":\"grp-floor-9-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-9-plugs-kW\"},{\"propertyName\":\"grp-floor-9-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-9-lghts-kW\"},{\"propertyName\":\"grp-floor-9-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-9-kW\"},{\"propertyName\":\"grp-section-9a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-9a-kW\"},{\"propertyName\":\"grp-section-9c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-9c-kW\"},{\"propertyName\":\"grp-section-9d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-9d-kW\"},{\"propertyName\":\"grp-floor-8-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-8-airhandlers-kW\"},{\"propertyName\":\"grp-floor-8-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-8-plugs-kW\"},{\"propertyName\":\"grp-floor-8-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-8-lghts-kW\"},{\"propertyName\":\"grp-floor-8-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-8-kW\"},{\"propertyName\":\"grp-section-8a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-8a-kW\"},{\"propertyName\":\"grp-section-8c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-8c-kW\"},{\"propertyName\":\"grp-section-8d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-8d-kW\"},{\"propertyName\":\"grp-floor-7-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-7-airhandlers-kW\"},{\"propertyName\":\"grp-floor-7-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-7-plugs-kW\"},{\"propertyName\":\"grp-floor-7-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-7-lghts-kW\"},{\"propertyName\":\"grp-floor-7-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-7-kW\"},{\"propertyName\":\"grp-section-7a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-7a-kW\"},{\"propertyName\":\"grp-section-7c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-7c-kW\"},{\"propertyName\":\"grp-section-7d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-7d-kW\"},{\"propertyName\":\"grp-floor-6-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-6-airhandlers-kW\"},{\"propertyName\":\"grp-floor-6-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-6-plugs-kW\"},{\"propertyName\":\"grp-floor-6-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-6-lghts-kW\"},{\"propertyName\":\"grp-floor-6-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-6-kW\"},{\"propertyName\":\"grp-section-6a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-6a-kW\"},{\"propertyName\":\"grp-section-6c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-6c-kW\"},{\"propertyName\":\"grp-section-6d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-6d-kW\"},{\"propertyName\":\"grp-floor-5-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-5-airhandlers-kW\"},{\"propertyName\":\"grp-floor-5-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-5-plugs-kW\"},{\"propertyName\":\"grp-floor-5-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-5-lghts-kW\"},{\"propertyName\":\"grp-floor-5-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-5-kW\"},{\"propertyName\":\"grp-section-5a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-5a-kW\"},{\"propertyName\":\"grp-section-5c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-5c-kW\"},{\"propertyName\":\"grp-section-5d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-5d-kW\"},{\"propertyName\":\"grp-floor-4-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-4-airhandlers-kW\"},{\"propertyName\":\"grp-floor-4-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-4-plugs-kW\"},{\"propertyName\":\"grp-floor-4-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-4-lghts-kW\"},{\"propertyName\":\"grp-floor-4-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-4-kW\"},{\"propertyName\":\"grp-section-4a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-4a-kW\"},{\"propertyName\":\"grp-section-4c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-4c-kW\"},{\"propertyName\":\"grp-section-4d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-4d-kW\"},{\"propertyName\":\"grp-floor-3-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-3-airhandlers-kW\"},{\"propertyName\":\"grp-floor-3-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-3-plugs-kW\"},{\"propertyName\":\"grp-floor-3-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-3-lghts-kW\"},{\"propertyName\":\"grp-floor-3-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-3-kW\"},{\"propertyName\":\"grp-section-3a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-3a-kW\"},{\"propertyName\":\"grp-section-3c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-3c-kW\"},{\"propertyName\":\"grp-section-3d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-3d-kW\"},{\"propertyName\":\"grp-floor-2-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-2-airhandlers-kW\"},{\"propertyName\":\"grp-floor-2-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-2-plugs-kW\"},{\"propertyName\":\"grp-floor-2-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-2-lghts-kW\"},{\"propertyName\":\"grp-floor-2-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-2-kW\"},{\"propertyName\":\"grp-section-2a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-2a-kW\"},{\"propertyName\":\"grp-section-2c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-2c-kW\"},{\"propertyName\":\"grp-section-2d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-2d-kW\"},{\"propertyName\":\"grp-floor-1-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-1-airhandlers-kW\"},{\"propertyName\":\"grp-floor-1-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-1-plugs-kW\"},{\"propertyName\":\"grp-floor-1-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-1-lghts-kW\"},{\"propertyName\":\"grp-floor-1-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-1-kW\"},{\"propertyName\":\"grp-section-1a-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-1a-kW\"},{\"propertyName\":\"grp-section-1c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-1c-kW\"},{\"propertyName\":\"grp-section-1d-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-1d-kW\"},{\"propertyName\":\"grp-floor-c-airhandlers-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-c-airhandlers-kW\"},{\"propertyName\":\"grp-floor-c-plugs-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-c-plugs-kW\"},{\"propertyName\":\"grp-floor-c-lghts-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-c-lghts-kW\"},{\"propertyName\":\"grp-floor-c-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-floor-c-kW\"},{\"propertyName\":\"grp-section-ca-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-ca-kW\"},{\"propertyName\":\"grp-section-cc-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-cc-kW\"},{\"propertyName\":\"grp-section-cd-kW-avg\",\"reducer\":\"avg\",\"segment\":\"grp-section-cd-kW\"}]}}}"
		} else if(newQuery == "run2") {
			newQuery = "{\"qid\":\"1235\",\"blade\":{\"domain\":\"4f6a2eec61faa7fe1d000035\",\"tenant\":\"4f6a314d61faa7fe1d000051\",\"category\":\"clamp-data\",\"period\":\"2012-08\"},\"query\":{\"range\":{\"start\":1344052800000,\"end\":1346731200000},\"category\":\"clamp-data\",\"match\":{\"resource\":{\"eq\":\"falling-waters\"}},\"group\":[{\"type\":\"resource\"}],\"reduce\":{\"reducers\":[{\"propertyName\":\"grp-total-hvac-avg\",\"reducer\":\"avg\",\"segment\":\"grp-total-hvac\"},{\"propertyName\":\"grp-total-plug-loads-avg\",\"reducer\":\"avg\",\"segment\":\"grp-total-plug-loads\"},{\"propertyName\":\"grp-total-lighting-avg\",\"reducer\":\"avg\",\"segment\":\"grp-total-lighting\"},{\"propertyName\":\"grp-total-power-avg\",\"reducer\":\"avg\",\"segment\":\"grp-total-power\"},{\"propertyName\":\"grp-office-hvac-avg\",\"reducer\":\"avg\",\"segment\":\"grp-office-hvac\"},{\"propertyName\":\"grp-office-plug-loads-avg\",\"reducer\":\"avg\",\"segment\":\"grp-office-plug-loads\"},{\"propertyName\":\"grp-office-lighting-avg\",\"reducer\":\"avg\",\"segment\":\"grp-office-lighting\"},{\"propertyName\":\"grp-office-power-avg\",\"reducer\":\"avg\",\"segment\":\"grp-office-power\"},{\"propertyName\":\"grp-it-hvac-avg\",\"reducer\":\"avg\",\"segment\":\"grp-it-hvac\"},{\"propertyName\":\"grp-it-plug-loads-avg\",\"reducer\":\"avg\",\"segment\":\"grp-it-plug-loads\"},{\"propertyName\":\"grp-it-lighting-avg\",\"reducer\":\"avg\",\"segment\":\"grp-it-lighting\"},{\"propertyName\":\"grp-it-power-avg\",\"reducer\":\"avg\",\"segment\":\"grp-it-power\"}]}}}"
		}
		bladeManager ! QueryDispatchRequest(newQuery)
	}

	actorSystem.shutdown
}